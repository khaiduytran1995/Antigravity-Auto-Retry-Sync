# Resolving Lag, Timeout, and API Endpoint Issues

We are addressing three main issues:
1.  **Crash/Timeout**: Due to missing `apiEndpoint` and lack of fallback. (Partially addressed with debug logs).
2.  **Lag**: Caused by multiple concurrent reCAPTCHA solves and hardware simulations in a single browser window when batching tasks.
3.  **Silent Failures**: Errors returning `{}` instead of descriptive messages.

## User Review Required

> [!IMPORTANT]
> I will be implementing a **serial queue** for reCAPTCHA solves. This means if you start 20 videos, they will solve reCAPTCHA one by one. This will prevent "Lag" but might make the *start* of a large batch look slower. However, it will be much more stable.

## Proposed Changes

### [tokenManager.js]
- [MODIFY] **Atomic Recovery Lock**: Set `isRecovering = true` as the absolute first line of `automatedRecovery` to prevent parallel entry.
- [MODIFY] **Strict API Blocking**: Update `mimicApiCall` to check for `isRecovering` and block immediately with a clear error if recovery is active.
- [MODIFY] **Robust Navigation Retry**: If `loadURL` fails with `ERR_ABORTED` during login, perform up to 3 retries instead of just ignoring it.
- [MODIFY] **Settling Period**: Add a 3-second delay after successful recovery before releasing the lock to allow window states to stabilize.

### [flowVideo.js] & [flowImage.js]
- [MODIFY] **Error-Aware Polling**: If a poll fails with "Failed to fetch" OR "RECOVERY_IN_PROGRESS", wait for the recovery promise instead of triggering a new one.

---

### [Component] Token Management (tokenManager.js)

#### [MODIFY] [tokenManager.js](file:///d:/14012026Veo%20Automation%20Setup%201.2.1/$PLUGINSDIR/Filegocdeupdate/Veo%20Automation/resources/app/dist-electron/services/tokenManager.js)

- **Serial Queue for reCAPTCHA**: Add a lock (Semaphore) to `getRecaptchaToken` to ensure only one solve occurs at a time per account.
- **Hardware Simulation Cleanup**: Refactor hardware simulation to be less intensive during concurrent calls.
- **Improved Error Catching**: Ensure `mimicApiCall` returns more descriptive objects on timeout.

---

### [Component] Video Service (flowVideo.js)

#### [MODIFY] [flowVideo.js](file:///d:/14012026Veo%20Automation%20Setup%201.2.1/$PLUGINSDIR/Filegocdeupdate/Veo%20Automation/resources/app/dist-electron/services/flowVideo.js)

- **Detailed Logging**: Add more descriptive logs for each stage (reCAPTCHA, API Send, API Response).
- **Endpoint Fallback**: Finalize the robust fallback for `apiEndpoint`.

---

### [Component] Image Service (flowImage.js / flowImageUpscale.js)

#### [MODIFY] [flowImage.js](file:///d:/14012026Veo%20Automation%20Setup%201.2.1/$PLUGINSDIR/Filegocdeupdate/Veo%20Automation/resources/app/dist-electron/services/flowImage.js)
#### [MODIFY] [flowImageUpscale.js](file:///d:/14012026Veo%20Automation%20Setup%201.2.1/$PLUGINSDIR/Filegocdeupdate/Veo%20Automation/resources/app/dist-electron/services/flowImageUpscale.js)

- **Consistent Error Reporting**: Apply the same detailed error reporting logic.

## Verification Plan

### Manual Verification
1.  Run a batch of 5+ videos.
2.  Observed the logs for `[TokenManager] Waiting for active reCAPTCHA solve...`.
3.  Verify that tasks no longer "Lag" the entire app UI.
4.  Verify that errors (if any) show descriptive text in the UI/Logs.
etConfig`.
4. Verify if the defensive check prevents the crash and allows the operation to proceed (or shows a more helpful error).
