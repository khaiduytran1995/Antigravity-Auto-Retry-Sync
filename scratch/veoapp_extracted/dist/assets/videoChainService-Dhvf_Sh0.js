import{P as e,l as t}from"./index-9w-QImJ4.js";const o=()=>"undefined"!=typeof window&&!!window.electronAPI;async function i(e){return new Promise((t,o)=>{const i=new FileReader;i.onloadend=()=>{const e=i.result,o=e.includes(",")?e.split(",")[1]:e;t(o)},i.onerror=o,i.readAsDataURL(e)})}async function n(t,o,n,l,a){var r,d,s,c;const p=(null==o?void 0:o.metadataEncodedVideo)||(null==t?void 0:t.encodedVideo);if(p){return p.includes(",")?p.split(",")[1]:p}const u=(null==o?void 0:o.upscaledVideoUrl)||(null==o?void 0:o.metadataVideoUrl)||(null==t?void 0:t.videoUrl);if(!u){a(`  ‚ö†Ô∏è Clip ${(null==t?void 0:t.clipId)||"unknown"} kh√¥ng c√≥ URL, th·ª≠ t·∫£i tr·ª±c ti·∫øp b·∫±ng clipId...`);const s=`${e}${(null==t?void 0:t.clipId)||(null==o?void 0:o.clipId)||""}`,c=await n.downloadVideo(s,{projectId:l});if(c instanceof Blob)return await i(c);if(c&&"object"==typeof c&&"filePath"in c&&c.filePath){if(!(null==(d=null==(r=window.electronAPI)?void 0:r.fs)?void 0:d.readFile))throw new Error("Kh√¥ng th·ªÉ ƒë·ªçc file video ƒë√£ t·∫£i (fs.readFile unavailable)");const e=await window.electronAPI.fs.readFile({filePath:c.filePath});if(!(null==e?void 0:e.success)||!e.data)throw new Error((null==e?void 0:e.error)||"Kh√¥ng th·ªÉ ƒë·ªçc file video ƒë√£ t·∫£i");return e.data}throw new Error(`Clip ${(null==t?void 0:t.clipId)||"unknown"} kh√¥ng c√≥ video URL ho·∫∑c d·ªØ li·ªáu ƒë·ªÉ t·∫£i`)}const h=await n.downloadVideo(u,{projectId:l});if(h instanceof Blob)return await i(h);if(h&&"object"==typeof h&&"filePath"in h&&h.filePath){if(!(null==(c=null==(s=window.electronAPI)?void 0:s.fs)?void 0:c.readFile))throw new Error("Kh√¥ng th·ªÉ ƒë·ªçc file FFmpeg output (fs.readFile unavailable)");const e=await window.electronAPI.fs.readFile({filePath:h.filePath});if(!(null==e?void 0:e.success)||!e.data)throw new Error((null==e?void 0:e.error)||"Kh√¥ng th·ªÉ ƒë·ªçc file video ƒë√£ t·∫£i");return e.data}throw new Error("Kh√¥ng th·ªÉ t·∫£i video clip ƒë·ªÉ concat")}async function l(e,t,i,l,a,r,d){var s,c;if(!o()||!(null==(c=null==(s=window.electronAPI)?void 0:s.ffmpeg)?void 0:c.mergeVideos))throw new Error("FFmpeg local merge ch·ªâ kh·∫£ d·ª•ng trong Electron");r(`  üß© ƒêang chu·∫©n b·ªã ${e.length} clip ƒë·ªÉ gh√©p b·∫±ng FFmpeg...`);const p=[],u=[];for(let o=0;o<e.length;o++){const i=e[o],d=t.find(e=>e.clipId===i.clipId),s=!(!(null==d?void 0:d.metadataEncodedVideo)&&!(null==i?void 0:i.encodedVideo)),c=(null==d?void 0:d.upscaledVideoUrl)||(null==d?void 0:d.metadataVideoUrl)||(null==i?void 0:i.videoUrl),h=!!c,v=!(!(null==i?void 0:i.clipId)&&!(null==d?void 0:d.clipId)),g=(null==i?void 0:i.clipId)||(null==d?void 0:d.clipId)||`index-${o}`,f=(null==d?void 0:d.startTime)||(null==i?void 0:i.startTimeOffset)||(null==i?void 0:i.startTime)||(0===o?"0.000000000s":"1.000000000s"),m=(null==d?void 0:d.endTime)||(null==i?void 0:i.endTimeOffset)||(null==i?void 0:i.endTime)||"8.000000000s";if(h)p.push({type:"url",value:c,startTimeOffset:f,endTimeOffset:m});else{if(s){const e=(null==d?void 0:d.metadataEncodedVideo)||(null==i?void 0:i.encodedVideo),t=e.includes(",")?e.split(",")[1]:e;p.push({type:"base64",value:t,startTimeOffset:f,endTimeOffset:m});continue}if(v)try{r(`    ‚ö†Ô∏è Clip ${o+1} kh√¥ng c√≥ URL, th·ª≠ t·∫£i fallback...`);const e=await n(i,d,l,a,r);p.push({type:"base64",value:e,startTimeOffset:f,endTimeOffset:m})}catch(U){u.push({clipId:g.length>20?`...${g.slice(-20)}`:g,index:o+1,error:U.message||"Unknown error"}),r(`    ‚ùå Clip ${o+1} l·ªói: ${U.message}`)}else u.push({clipId:"unknown",index:o+1,error:"Kh√¥ng c√≥ d·ªØ li·ªáu video"})}}if(0===p.length)throw new Error(`Gh√©p clips th·∫•t b·∫°i: Kh√¥ng c√≥ clip n√†o h·ª£p l·ªá. ${u.length} clip l·ªói.`);u.length>0&&r(`  ‚ö†Ô∏è C·∫£nh b√°o: ${u.length} clip(s) b·ªã l·ªói, s·∫Ω gh√©p ${p.length} clip(s) c√≤n l·∫°i`);const h=`chain_${i+1}_${Date.now()}.mp4`,v=p.length,g=v>=10?"veryfast":v>=6?"fast":void 0,f=v>=12?4:v>=9?5:v>=6?6:void 0,m=window.electronAPI;r(`  üé¨ ƒêang gh√©p n·ªëi ${p.length} clip (Mixed sources)...`);const I=await m.ffmpeg.mergeVideos({videos:p,outputPath:h,aspectRatio:d||"16:9",maxInputsPerPass:f,encodingPreset:g});if(!(null==I?void 0:I.success))throw new Error((null==I?void 0:I.error)||"FFmpeg merge th·∫•t b·∫°i");const w=I.outputPath||h;if(r("  ‚úÖ ƒê√£ gh√©p n·ªëi xong"),o()){return{videoUrl:function(e){const t=e.replace(/\\/g,"/");return`local-media://${encodeURIComponent(t)}`}(w),outputPath:w}}const $=await async function(e){if(!o())return null;try{const t=await window.electronAPI.fs.readFile({filePath:e});if(!(null==t?void 0:t.success)||!t.data)return null;const o=atob(t.data),i=new Uint8Array(o.length);for(let e=0;e<o.length;e++)i[e]=o.charCodeAt(e);const n=new Blob([i],{type:"video/mp4"});return URL.createObjectURL(n)}catch(U){return null}}(w);if(!$)throw new Error("Kh√¥ng th·ªÉ t·∫°o blob URL t·ª´ FFmpeg output");return{videoUrl:$,outputPath:w}}function a(e,o,i,n){const l=[],a=[];e.split(/\s+/).forEach(e=>{const t=e.replace(/[^\w\u00C0-\u024F\u1E00-\u1EFF]/g,"").toLowerCase();if(o[t]){const e=o[t];l.includes(e)||(l.push(e),a.push(t))}}),0===l.length&&i.forEach(e=>{const t=o[e];t&&!l.includes(t)&&(l.push(t),a.includes(e)||a.push(e))});const{limitedMediaIds:r}=t(l,a,e,n);return r}async function r(t,o,i,r,d,s,c,p,u){var h,v,g,f,m,I,w,$,U,E,P,T,b,A,R,S,y,V,F,C,G,O,_,K,M,x,D,k,N,L,B;const j=[];let q=0,H=p,X=u;p&&j.push({clipId:p,startTime:"0.000000000s",endTime:"8.000000000s",prompt:"Previous Chain Last Clip"});for(let e=0;e<i.length;e++){const n=i[e];s(r,e+1,i.length);try{let l;if(0!==e||p){if(!!H){if(c(`  üé¨ Prompt ${e+1}/${i.length}: Extend video...`),!H)throw new Error("Kh√¥ng c√≥ clip ID ƒë·ªÉ extend");c(`   Clip ID: ...${H.slice(-12)}`),c("   Frame range: 168-192 (last 1s)"),X&&c(`   Scene ID: ...${X.slice(-12)}`);const a=await t.extendVideo(o,n,H,168,192,X||crypto.randomUUID(),d.aspectRatio,d.modelMode||"free"),r=await t.pollVideoStatus(a.operations,{interval:15e3,onProgress:e=>{e.operations.filter(e=>"MEDIA_GENERATION_STATUS_IN_PROGRESS"===e.status).length>0&&c("    ‚è≥ ƒêang extend video...")}}),s=null==(F=r.operations[0])?void 0:F.mediaGenerationId;if(!s)throw new Error("Kh√¥ng c√≥ clip ID ƒë∆∞·ª£c tr·∫£ v·ªÅ t·ª´ API");const u=null==(_=null==(O=null==(G=null==(C=r.operations)?void 0:C[0])?void 0:G.operation)?void 0:O.metadata)?void 0:_.video,h=(null==u?void 0:u.fifeUrl)||(null==u?void 0:u.servingBaseUri),v=null==(K=r.operations[0])?void 0:K.sceneId;l={clipId:s,startTime:0===j.length&&!p?"0.000000000s":"1.000000000s",endTime:"8.000000000s",prompt:n,operations:r.operations,metadataVideoUrl:h},H=s,v&&(X=v)}else{let r;if(d.placeholderMediaIds&&d.availablePlaceholders&&d.availablePlaceholders.length>0){c(`  üé• Prompt ${e+1}/${i.length}: T·∫°o video t·ª´ reference images (Component mode, prompts tr∆∞·ªõc b·ªã skip)...`);const l=a(n,d.placeholderMediaIds,d.availablePlaceholders,c);if(0===l.length)throw new Error("Kh√¥ng c√≥ media ID n√†o ƒë·ªÉ s·ª≠ d·ª•ng cho component mode");r=await t.generateVideosFromMultipleImages(o,l,n,1,d.aspectRatio,d.modelMode||"free")}else c(`  üé• Prompt ${e+1}/${i.length}: T·∫°o video ƒë·∫ßu ti√™n t·ª´ text (prompts tr∆∞·ªõc b·ªã skip)...`),r=await t.generateVideosFromText(o,n,1,d.aspectRatio,void 0,d.modelMode||"free");const s=await t.pollVideoStatus(r.operations,{interval:15e3,onProgress:e=>{e.operations.filter(e=>"MEDIA_GENERATION_STATUS_IN_PROGRESS"===e.status).length>0&&c("    ‚è≥ ƒêang t·∫°o video...")}}),u=null==(b=s.operations[0])?void 0:b.mediaGenerationId;if(!u)throw new Error("Kh√¥ng c√≥ clip ID ƒë∆∞·ª£c tr·∫£ v·ªÅ t·ª´ API");const h=null==(y=null==(S=null==(R=null==(A=s.operations)?void 0:A[0])?void 0:R.operation)?void 0:S.metadata)?void 0:y.video,v=(null==h?void 0:h.fifeUrl)||(null==h?void 0:h.servingBaseUri)||(null==h?void 0:h.signedUri),g=null==(V=s.operations[0])?void 0:V.sceneId;l={clipId:u,startTime:0===j.length&&!p?"0.000000000s":"1.000000000s",endTime:"8.000000000s",prompt:n,operations:s.operations,metadataVideoUrl:v},H=u,g&&(X=g)}}else{if(d.placeholderMediaIds&&d.availablePlaceholders&&d.availablePlaceholders.length>0){c(`  üé¨ Prompt ${e+1}/${i.length}: T·∫°o video t·ª´ reference images (Component mode)...`);const r=a(n,d.placeholderMediaIds,d.availablePlaceholders,c);if(0===r.length)throw new Error("Kh√¥ng c√≥ media ID n√†o ƒë·ªÉ s·ª≠ d·ª•ng cho component mode");const s=await t.generateVideosFromMultipleImages(o,r,n,1,d.aspectRatio,d.modelMode||"free"),u=await t.pollVideoStatus(s.operations,{interval:15e3,onProgress:e=>{e.operations.filter(e=>"MEDIA_GENERATION_STATUS_IN_PROGRESS"===e.status).length>0&&c("    ‚è≥ ƒêang t·∫°o video...")}}),w=null==(h=u.operations[0])?void 0:h.mediaGenerationId;if(!w)throw new Error("Kh√¥ng c√≥ clip ID ƒë∆∞·ª£c tr·∫£ v·ªÅ t·ª´ API");const $=null==(m=null==(f=null==(g=null==(v=u.operations)?void 0:v[0])?void 0:g.operation)?void 0:f.metadata)?void 0:m.video,U=(null==$?void 0:$.fifeUrl)||(null==$?void 0:$.servingBaseUri),E=null==(I=u.operations[0])?void 0:I.sceneId;l={clipId:w,startTime:0===e&&!p?"0.000000000s":"1.000000000s",endTime:"8.000000000s",prompt:n,operations:u.operations,metadataVideoUrl:U},H=w,E&&(X=E)}else{c(`  üé¨ Prompt ${e+1}/${i.length}: T·∫°o video t·ª´ text...`);const a=await t.generateVideosFromText(o,n,1,d.aspectRatio,d.modelKey,d.modelMode||"free"),r=await t.pollVideoStatus(a.operations,{interval:15e3,onProgress:e=>{e.operations.filter(e=>"MEDIA_GENERATION_STATUS_IN_PROGRESS"===e.status).length>0&&c("    ‚è≥ ƒêang t·∫°o video...")}}),s=null==(w=r.operations[0])?void 0:w.mediaGenerationId;if(!s)throw new Error("Kh√¥ng c√≥ clip ID ƒë∆∞·ª£c tr·∫£ v·ªÅ t·ª´ API");const u=null==(P=null==(E=null==(U=null==($=r.operations)?void 0:$[0])?void 0:U.operation)?void 0:E.metadata)?void 0:P.video,h=(null==u?void 0:u.fifeUrl)||(null==u?void 0:u.servingBaseUri),v=null==(T=r.operations[0])?void 0:T.sceneId;l={clipId:s,startTime:0===e&&!p?"0.000000000s":"1.000000000s",endTime:"8.000000000s",prompt:n,operations:r.operations,metadataVideoUrl:h},H=s,v&&(X=v)}}j.push(l),c(`  ‚úÖ Video ƒë√£ t·∫°o (Clip ID: ...${l.clipId.slice(-12)})`)}catch(Y){c(`  ‚ùå Prompt ${e+1} th·∫•t b·∫°i: ${Y.message}`),q++}}if(d.upscale&&d.upsamplerKey)try{const e="1080p"===d.upscale?"1080p":"4K";c(`  üîº B·∫Øt ƒë·∫ßu upscale ${j.length} clips l√™n ${e} (batch processing)...`);const o=j.filter(e=>e.clipId&&""!==e.clipId.trim()).map(e=>({videoUrl:e.metadataVideoUrl,mediaGenerationId:e.clipId})),i=o.filter(e=>e.mediaGenerationId),n=o.length-i.length;if(0===i.length)c("  ‚ö†Ô∏è Kh√¥ng c√≥ clip n√†o c√≥ mediaGenerationId h·ª£p l·ªá ƒë·ªÉ upscale"),n>0&&c(`  ‚ö†Ô∏è ${n} clip(s) c√≥ clipId nh∆∞ng kh√¥ng c√≥ mediaGenerationId h·ª£p l·ªá`);else{n>0&&c(`  ‚ö†Ô∏è ${n} clip(s) kh√¥ng c√≥ mediaGenerationId h·ª£p l·ªá, s·∫Ω b·ªè qua`);const e=Math.ceil(i.length/4);let o;c(`  üìã S·∫Ω upscale ${i.length} clip(s) theo ${e} batch(es) (max 4/batch, delay 15s gi·ªØa c√°c batch)`);try{o=await t.upsampleT2vVideos(i,d.aspectRatio,d.upsamplerKey)}catch(Y){if(!(429===(null==(M=null==Y?void 0:Y.response)?void 0:M.status)||(null==(x=null==Y?void 0:Y.message)?void 0:x.includes("429"))||(null==(D=null==Y?void 0:Y.message)?void 0:D.includes("RESOURCE_EXHAUSTED"))||429===(null==(L=null==(N=null==(k=null==Y?void 0:Y.response)?void 0:k.data)?void 0:N.error)?void 0:L.code)||(null==Y?void 0:Y.is429Error)))throw Y;if(!((null==Y?void 0:Y.partialOperations)&&Y.partialOperations.length>0))return void c("  ‚ö†Ô∏è Kh√¥ng c√≥ video n√†o ƒë∆∞·ª£c upscale do l·ªói 429, s·∫Ω s·ª≠ d·ª•ng video g·ªëc");c(`  ‚ö†Ô∏è Upscale g·∫∑p l·ªói 429, nh∆∞ng ${Y.partialOperations.length} video(s) ƒë√£ ƒë∆∞·ª£c t·∫°o operations`),o={operations:Y.partialOperations}}if(!o||!o.operations||0===o.operations.length)return void c("  ‚ö†Ô∏è Kh√¥ng c√≥ operations n√†o ƒë∆∞·ª£c t·∫°o, s·∫Ω s·ª≠ d·ª•ng video g·ªëc");c(`  ‚ÑπÔ∏è ƒê√£ t·∫°o ${o.operations.length}/${i.length} operations`);const l=await t.pollVideoStatus(o.operations,{interval:15e3,maxAttempts:35,onProgress:e=>{const t=e.operations.filter(e=>"MEDIA_GENERATION_STATUS_IN_PROGRESS"===e.status).length,o=e.operations.filter(e=>"MEDIA_GENERATION_STATUS_SUCCESSFUL"===e.status).length;(t>0||o<e.operations.length)&&c(`    ‚è≥ ƒêang upscale: ${o}/${e.operations.length} ho√†n th√†nh, ${t} ƒëang x·ª≠ l√Ω...`)}}),a=t.extractVideoUrls(l)||[];if(c(`  ‚ÑπÔ∏è Extract ƒë∆∞·ª£c ${a.length} upscaled records t·ª´ ${l.operations.length} operations`),a&&a.length>0){let e=0;const t=new Map;i.forEach((e,o)=>{const i=a[o];(null==i?void 0:i.videoUrl)&&(null==i?void 0:i.mediaGenerationId)&&e.mediaGenerationId&&t.set(e.mediaGenerationId,i)}),j.forEach((o,i)=>{if(!o.clipId||""===o.clipId.trim())return;const n=t.get(o.clipId);(null==n?void 0:n.videoUrl)&&(null==n?void 0:n.mediaGenerationId)?(o.upscaledVideoUrl=n.videoUrl,o.upscaledMediaGenerationId=n.mediaGenerationId,e++,c(`    ‚úÖ Clip ${i+1} ƒë√£ upscale: ...${o.clipId.slice(-12)}`)):c(`    ‚ö†Ô∏è Clip ${i+1} upscale kh√¥ng c√≥ k·∫øt qu·∫£, s·∫Ω d√πng video g·ªëc`)}),c(`  ‚úÖ Upscale ho√†n th√†nh: ${e}/${i.length} clips ƒë∆∞·ª£c upscale th√†nh c√¥ng`)}else c("  ‚ö†Ô∏è Kh√¥ng c√≥ video upscaled n√†o ƒë∆∞·ª£c tr·∫£ v·ªÅ, s·∫Ω s·ª≠ d·ª•ng video g·ªëc")}}catch(Y){c(`  ‚ö†Ô∏è Upscale th·∫•t b·∫°i: ${Y.message}`),c("  ‚ÑπÔ∏è Ti·∫øp t·ª•c v·ªõi video g·ªëc, kh√¥ng l√†m gi√°n ƒëo·∫°n workflow")}const z=H||(null==(B=j[j.length-1])?void 0:B.clipId)||"",J=p?j.slice(1):j;if(0===J.length)throw new Error("Kh√¥ng c√≥ clip n√†o ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng");let Q,W="";if(1===J.length){const i=J[0],l=j.find(e=>e.clipId===i.clipId);try{const e=function(e,t="video/mp4"){const o=atob(e),i=o.length,n=new Uint8Array(i);for(let l=0;l<i;l++)n[l]=o.charCodeAt(l);return new Blob([n],{type:t})}(await n(i,l,t,o,c),"video/mp4");W=URL.createObjectURL(e),c("  ‚úì S·ª≠ d·ª•ng clip duy nh·∫•t sau khi chuy·ªÉn th√†nh blob URL")}catch(Z){c(`  ‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫°o blob t·ª´ clip duy nh·∫•t: ${Z.message}`),W=`${e}${i.clipId}`,c("  ‚ö†Ô∏è Clip duy nh·∫•t kh√¥ng c√≥ d·ªØ li·ªáu, s·ª≠ d·ª•ng placeholder ƒë·ªÉ t·∫£i sau")}}else{const e=await l(J,j,r,t,o,c,d.aspectRatio);W=e.videoUrl,Q=e.outputPath}return{videoUrl:W,clips:J,failedPrompts:q,lastClipId:z,lastSceneId:X||"",localFilePath:Q}}async function d(e,t,o,i,n,l,a){const d=Math.max(1,Math.min(100,i.maxPromptsPerChain||10)),s=function(e,t){const o=[];for(let i=0;i<e.length;i+=t)o.push(e.slice(i,i+t));return o}(t,d),c=[];let p,u;l(`üìä T·ªïng s·ªë prompts: ${t.length}`),l(`üìä S·ªë chains: ${s.length} (m·ªói chain ${d} prompts)`);for(let v=0;v<s.length;v++){const t=s[v];l(`\n${"=".repeat(60)}`),l(`üöÄ B·∫ÆT ƒê·∫¶U CHAIN ${v+1}/${s.length}`),l(`${"=".repeat(60)}`);try{const d=await r(e,o,t,v,i,n,l,p,u);c.push(d.videoUrl),p=d.lastClipId,u=d.lastSceneId,a(v,d.videoUrl,d.localFilePath)}catch(h){l(`  ‚ùå Chain ${v+1} th·∫•t b·∫°i: ${h.message}`)}}return c}export{d as processMultiPromptChain};
